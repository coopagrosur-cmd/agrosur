<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgroSur ‚Äì Frutas y Verduras</title>

<style>
/* Estilos Base mejorados */
body { font-family:'Segoe UI',Arial,sans-serif; margin:0; background:#fffdf5; padding-bottom: 220px; }
header { background:linear-gradient(90deg,#ff9800,#4caf50); color:white; padding:25px; }
.header-contenido { display:flex; gap:18px; align-items:center; justify-content:center; flex-wrap:wrap; text-align:center; }
.logo { max-width:120px; border-radius:50%; background:white; padding:5px; }

section { padding:25px; max-width:1200px; margin:auto; }

.filtros { text-align:center; margin-bottom:25px; position: sticky; top: 0; background: #fffdf5; padding: 10px; z-index: 10; border-bottom: 1px dashed #4caf50; }
.filtros button { 
    width:auto; margin:5px; padding:10px 18px; 
    background: #4caf50; border: none; color: white; 
    border-radius: 20px; cursor: pointer; font-weight: bold;
}
.filtros button:hover { background: #388e3c; }

.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px; }

.card { background:white; border-radius:14px; padding:15px; box-shadow:0 6px 14px rgba(0,0,0,.12); text-align:center; display: flex; flex-direction: column; justify-content: space-between; }
.card img { width:100%; height:150px; object-fit:cover; border-radius:10px; background:#f0f0f0; margin-bottom: 10px; }
.precio { font-weight:bold; margin:8px 0; font-size: 1.2rem; color: #2e7d32; }

button.btn-add { background:#ff9800; color:white; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer; font-weight:bold; transition: 0.2s; }
button.btn-add:hover { background:#fb8c00; transform: scale(1.02); }

/* Carrito Flotante */
#carrito {
  position:fixed; bottom:0; left:0; right:0;
  background:#fff; border-top:5px solid #ff9800;
  padding:15px; box-shadow:0 -5px 20px rgba(0,0,0,0.2);
  max-height:200px; overflow-y:auto; z-index: 100;
}
.item-carrito { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; font-size: 0.95rem; }
.btn-del { background:#ffeded; color:#d32f2f; border:1px solid #ffcdd2; border-radius:5px; padding:2px 8px; cursor:pointer; }
</style>
</head>

<body>

<header>
  <div class="header-contenido">
    <img class="logo" src="https://raw.githubusercontent.com/coopagrosur-cmd/imagenes-agrosur/refs/heads/main/logo.png" alt="Logo">
    <div>
      <h1>AgroSur Frutas y Verduras</h1>
      <p>Del productor a tu mesa</p>
    </div>
  </div>
</header>

<section>
  <h2>üì¶ Cajas Armadas</h2>
  <div class="grid" id="cajas"></div>
</section>

<section>
  <div class="filtros">
    <button onclick="filtrar('todas')">üõí Todos</button>
    <button onclick="filtrar('frutas')">üçé Frutas</button>
    <button onclick="filtrar('verduras')">ü•¨ Verduras</button>
    <button onclick="filtrar('hortalizas')">üå± Hortalizas</button>
  </div>

  <div id="contenedor-frutas" class="seccion-categoria">
    <h2>üçé Frutas</h2>
    <div class="grid" id="grid-frutas"></div>
  </div>

  <div id="contenedor-verduras" class="seccion-categoria">
    <h2>ü•¨ Verduras</h2>
    <div class="grid" id="grid-verduras"></div>
  </div>

  <div id="contenedor-hortalizas" class="seccion-categoria">
    <h2>üå± Hortalizas</h2>
    <div class="grid" id="grid-hortalizas"></div>
  </div>
</section>

<div id="carrito">
  <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 2px solid #4caf50; padding-bottom: 5px; margin-bottom: 10px;">
    <h3 style="margin:0;">üß∫ Tu Pedido</h3>
    <strong>Total: $<span id="total">0</span></strong>
  </div>
  <div id="items-carrito"></div>
  <button class="btn-add" style="margin-top: 10px;" onclick="finalizarPedido()">Finalizar pedido por WhatsApp</button>
</div>

<script>
const telefono = '5492213084604';

const sheetProductos = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSslFktyPHbT0hm76An5Y5zwQlT98bQSiMQgTz7hXDs5AngXqHbFOpm5vs_hINDF4SAILG1s1Rm95NR/pub?gid=0&single=true&output=csv';
const sheetCajas = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSOm48PgZGpZtF2vxg2g5UX1xB0yQ_-Hkx2UbHRPRFvB0ZN4Xmw3ZRIwxAFk3O6jXI5eqhLub-FaaIT/pub?gid=0&single=true&output=csv';

let carrito = [];

function mapCategoria(cat) {
  if (!cat) return null;
  const c = cat.toLowerCase();
  if (c.includes('fruta')) return 'frutas';
  if (c.includes('verdura')) return 'verduras';
  if (c.includes('hortaliza')) return 'hortalizas';
  return null;
}

function parseCSV(text) {
  const sep = text.includes(';') ? ';' : ',';
  return text.trim().split('\n').map(l => {
    let r = [], c = '', q = false;
    for (let i = 0; i < l.length; i++) {
      if (l[i] === '"') q = !q;
      else if (l[i] === sep && !q) { r.push(c); c = ''; }
      else c += l[i];
    }
    r.push(c);
    return r.map(x => x.replace(/^"|"$/g, '').trim());
  });
}

/* Carga de Productos */
fetch(sheetProductos)
  .then(r => r.text())
  .then(t => {
    parseCSV(t).slice(1).forEach(([cat, n, p, u, img]) => {
      const catLimpia = mapCategoria(cat);
      const grid = document.getElementById(`grid-${catLimpia}`);
      if (grid && n) {
        grid.innerHTML += `
          <div class="card">
            <img src="${img}" onerror="this.src='https://via.placeholder.com/150?text=AgroSur'">
            <div>
              <h3>${n}</h3>
              <div class="precio">$${p} <small>/ ${u}</small></div>
            </div>
            <button class="btn-add" onclick="add('${n}',${p},'${u}')">Agregar al carrito</button>
          </div>`;
      }
    });
  });

/* Carga de Cajas (Ahora se agregan al carrito) */
fetch(sheetCajas)
  .then(r => r.text())
  .then(t => {
    parseCSV(t).slice(1).forEach(([n, d, p, img]) => {
      if (!n) return;
      document.getElementById('cajas').innerHTML += `
        <div class="card">
          <img src="${img}" onerror="this.src='https://via.placeholder.com/150?text=Caja+AgroSur'">
          <div>
            <h3>${n}</h3>
            <p style="font-size: 0.85rem; color: #666;">${d}</p>
            <div class="precio">$${p}</div>
          </div>
          <button class="btn-add" onclick="add('${n}',${p},'Caja')">Quiero esta Caja</button>
        </div>`;
    });
  });

function filtrar(cat) {
  document.querySelectorAll('.seccion-categoria').forEach(sec => {
    sec.style.display = (cat === 'todas' || sec.id === `contenedor-${cat}`) ? 'block' : 'none';
  });
}

/* --- CARRITO --- */
function add(n, p, u) { 
  carrito.push({ n, p: parseFloat(p), u }); 
  render(); 
}

function render() {
  const contenedorItems = document.getElementById('items-carrito');
  const contenedorTotal = document.getElementById('total');
  let total = 0;
  let html = '';

  carrito.forEach((i, idx) => {
    total += i.p;
    html += `
      <div class="item-carrito">
        <span><strong>${i.n}</strong> (${i.u}) - $${i.p}</span>
        <button class="btn-del" onclick="del(${idx})">‚úï</button>
      </div>`;
  });

  contenedorItems.innerHTML = html || '<p style="color:#999; text-align:center;">El carrito est√° vac√≠o</p>';
  contenedorTotal.innerText = total.toLocaleString();
}

function del(idx) { 
  carrito.splice(idx, 1); 
  render(); 
}

/* --- WHATSAPP CON DETALLE DE UNIDADES --- */
function finalizarPedido() {
  if (carrito.length === 0) return alert('El carrito est√° vac√≠o');
  
  let resumen = {};
  let total = 0;
  
  // Agrupamos por nombre para sumar cantidades
  carrito.forEach(i => {
    if(!resumen[i.n]) {
      resumen[i.n] = { qty: 0, unit: i.u, subtotal: 0 };
    }
    resumen[i.n].qty += 1;
    resumen[i.n].subtotal += i.p;
    total += i.p;
  });

  let msg = 'ü•¶ *Nuevo Pedido - AgroSur* %0A%0A';
  msg += 'Hola! Quiero realizar el siguiente pedido:%0A%0A';
  
  for (let prod in resumen) {
    const item = resumen[prod];
    // Formato: - Manzana: 2 (kg)
    msg += `‚Ä¢ *${prod}*: ${item.qty} (${item.unit})%0A`;
  }
  
  msg += `%0Aüí∞ *Total a pagar: $${total}*`;
  msg += `%0A%0Aüìç _Por favor, coordine la entrega conmigo._`;
  
  window.open(`https://wa.me/${telefono}?text=${msg}`);
}
</script>

</body>
</html>
