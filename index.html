<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgroSur ‚Äì Frutas y Verduras</title>

<style>
/* Estilos Base */
body { font-family:'Segoe UI',Arial,sans-serif; margin:0; background:#fffdf5; padding-bottom: 200px; }
header { background:linear-gradient(90deg,#ff9800,#4caf50); color:white; padding:25px; }
.header-contenido { display:flex; gap:18px; align-items:center; justify-content:center; flex-wrap:wrap; text-align:center; }
.logo { max-width:120px; border-radius:50%; background:white; padding:5px; }

section { padding:25px; max-width:1200px; margin:auto; }

/* Filtros */
.filtros { text-align:center; margin-bottom:25px; position: sticky; top: 0; background: #fffdf5; padding: 10px; z-index: 10; }
.filtros button { 
    width:auto; margin:5px; padding:10px 18px; 
    background: #4caf50; border: none; color: white; 
    border-radius: 20px; cursor: pointer; font-weight: bold;
}
.filtros button:hover { background: #388e3c; }

.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:18px; }

/* Tarjetas */
.card { background:white; border-radius:14px; padding:15px; box-shadow:0 6px 14px rgba(0,0,0,.12); text-align:center; }
.card img { width:100%; height:150px; object-fit:cover; border-radius:10px; background:#f0f0f0; }
.precio { font-weight:bold; margin:8px 0; font-size: 1.2rem; color: #2e7d32; }

button.btn-add { background:#ff9800; color:white; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer; font-weight:bold; }
button.btn-add:hover { background:#fb8c00; }

footer { background:#2e7d32; color:white; text-align:center; padding:18px; }

/* Carrito Flotante */
#carrito {
  position:fixed; bottom:0; left:0; right:0;
  background:#fff; border-top:4px solid #4caf50;
  padding:15px; box-shadow:0 -4px 15px rgba(0,0,0,0.2);
  max-height:180px; overflow-y:auto; z-index: 100;
}
.item-carrito { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
</style>
</head>

<body>

<header>
  <div class="header-contenido">
    <img class="logo" src="https://raw.githubusercontent.com/coopagrosur-cmd/imagenes-agrosur/refs/heads/main/logo.png" alt="Logo">
    <div>
      <h1>AgroSur Frutas y Verduras</h1>
      <p>Del productor a tu mesa</p>
    </div>
  </div>
</header>

<section>
  <h2>üì¶ Cajas Armadas</h2>
  <div class="grid" id="cajas"></div>
</section>

<section>
  <div class="filtros">
    <button onclick="filtrar('todas')">üõí Todos</button>
    <button onclick="filtrar('frutas')">üçé Frutas</button>
    <button onclick="filtrar('verduras')">ü•¨ Verduras</button>
    <button onclick="filtrar('hortalizas')">üå± Hortalizas</button>
  </div>

  <div id="contenedor-frutas" class="seccion-categoria">
    <h2>üçé Frutas</h2>
    <div class="grid" id="grid-frutas"></div>
  </div>

  <div id="contenedor-verduras" class="seccion-categoria">
    <h2>ü•¨ Verduras</h2>
    <div class="grid" id="grid-verduras"></div>
  </div>

  <div id="contenedor-hortalizas" class="seccion-categoria">
    <h2>üå± Hortalizas</h2>
    <div class="grid" id="grid-hortalizas"></div>
  </div>
</section>

<div id="carrito">
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h3 style="margin:0;">üß∫ Tu pedido</h3>
    <strong>Total: $<span id="total">0</span></strong>
  </div>
  <div id="items-carrito" style="margin: 10px 0;"></div>
  <button class="btn-add" onclick="finalizarPedido()">Finalizar pedido por WhatsApp</button>
</div>

<script>
const telefono = '5492213084604';

const sheetProductos = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSslFktyPHbT0hm76An5Y5zwQlT98bQSiMQgTz7hXDs5AngXqHbFOpm5vs_hINDF4SAILG1s1Rm95NR/pub?gid=0&single=true&output=csv';
const sheetCajas = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSOm48PgZGpZtF2vxg2g5UX1xB0yQ_-Hkx2UbHRPRFvB0ZN4Xmw3ZRIwxAFk3O6jXI5eqhLub-FaaIT/pub?gid=0&single=true&output=csv';

let carrito = [];

/* Mapeo de categor√≠as para evitar errores de escritura en el Excel */
function mapCategoria(cat) {
  if (!cat) return null;
  const c = cat.toLowerCase();
  if (c.includes('fruta')) return 'frutas';
  if (c.includes('verdura')) return 'verduras';
  if (c.includes('hortaliza')) return 'hortalizas';
  return null;
}

function parseCSV(text) {
  const sep = text.includes(';') ? ';' : ',';
  return text.trim().split('\n').map(l => {
    let r = [], c = '', q = false;
    for (let i = 0; i < l.length; i++) {
      if (l[i] === '"') q = !q;
      else if (l[i] === sep && !q) { r.push(c); c = ''; }
      else c += l[i];
    }
    r.push(c);
    return r.map(x => x.replace(/^"|"$/g, '').trim());
  });
}

/* Carga de Productos */
fetch(sheetProductos)
  .then(r => r.text())
  .then(t => {
    const filas = parseCSV(t).slice(1);
    filas.forEach(([cat, n, p, u, img]) => {
      const catLimpia = mapCategoria(cat);
      const gridId = `grid-${catLimpia}`;
      const grid = document.getElementById(gridId);
      
      if (grid && n) {
        grid.innerHTML += `
          <div class="card">
            <img src="${img}" onerror="this.src='https://via.placeholder.com/150?text=AgroSur'">
            <h3>${n}</h3>
            <div class="precio">$${p} <small>/ ${u}</small></div>
            <button class="btn-add" onclick="add('${n}',${p},'${u}')">Agregar</button>
          </div>`;
      }
    });
  });

/* Carga de Cajas */
fetch(sheetCajas)
  .then(r => r.text())
  .then(t => {
    const filas = parseCSV(t).slice(1);
    filas.forEach(([n, d, p, img]) => {
      if (!n) return;
      document.getElementById('cajas').innerHTML += `
        <div class="card">
          <img src="${img}" onerror="this.src='https://via.placeholder.com/150?text=Caja+AgroSur'">
          <h3>${n}</h3>
          <p>${d}</p>
          <div class="precio">$${p}</div>
          <button class="btn-add" onclick="caja('${n}',${p})">Pedir Caja</button>
        </div>`;
    });
  });

/* L√≥gica de Filtros */
function filtrar(cat) {
  const secciones = document.querySelectorAll('.seccion-categoria');
  secciones.forEach(sec => {
    if (cat === 'todas') {
      sec.style.display = 'block';
    } else {
      sec.style.display = sec.id === `contenedor-${cat}` ? 'block' : 'none';
    }
  });
}

/* L√≥gica del Carrito */
function add(n, p, u) { 
  carrito.push({ n, p: parseFloat(p), u }); 
  render(); 
}

function render() {
  const contenedorItems = document.getElementById('items-carrito');
  const contenedorTotal = document.getElementById('total');
  let total = 0;
  let html = '';

  carrito.forEach((i, idx) => {
    total += i.p;
    html += `
      <div class="item-carrito">
        <span>${i.n} ($${i.p})</span>
        <button onclick="del(${idx})" style="background:red; color:white; border:none; border-radius:5px; cursor:pointer;">‚úï</button>
      </div>`;
  });

  contenedorItems.innerHTML = html;
  contenedorTotal.innerText = total.toLocaleString();
}

function del(idx) { 
  carrito.splice(idx, 1); 
  render(); 
}

function finalizarPedido() {
  if (carrito.length === 0) return alert('El carrito est√° vac√≠o');
  let resumen = {};
  let total = 0;
  carrito.forEach(i => {
    resumen[i.n] = (resumen[i.n] || 0) + 1;
    total += i.p;
  });

  let msg = 'Hola AgroSur! Quiero realizar este pedido:%0A%0A';
  for (let prod in resumen) {
    msg += `‚Ä¢ ${prod} x${resumen[prod]}%0A`;
  }
  msg += `%0A*Total: $${total}*`;
  window.open(`https://wa.me/${telefono}?text=${msg}`);
}

function caja(n, p) {
  const msg = `Hola AgroSur! Quiero pedir la ${n} por $${p}`;
  window.open(`https://wa.me/${telefono}?text=${encodeURIComponent(msg)}`);
}
</script>

</body>
</html>
